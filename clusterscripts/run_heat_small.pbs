#!/bin/bash
#PBS -N run_heat_fast
#PBS -q standard
#PBS -l nodes=1:ppn=1,mem=1900mb,walltime=00:30:00
#PBS -m bea
#PBS -M ok24@ic.ac.uk
#PBS -j oe
#PBS -o /home/ma/o/ok24/logs/${PBS_JOBID}.log
#PBS -V

set -euo pipefail
set -x

# --- logs ---
mkdir -p /home/ma/o/ok24/logs
exec >"/home/ma/o/ok24/logs/${PBS_JOBID}.log" 2>&1
echo "[START] $(date) host=$(hostname) job=${PBS_JOBID} user=${USER}"

# --- hilos BLAS/OpenMP a 1 ---
export OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 MKL_NUM_THREADS=1 \
       BLIS_NUM_THREADS=1 VECLIB_MAXIMUM_THREADS=1 NUMEXPR_NUM_THREADS=1 \
       GOTO_NUM_THREADS=1

# --- firedrake ---
source /usr/local/firedrake/bin/activate
which python3
python3 -V

# --- caches de usuario (antes de importar nada) ---
export HOME=/home/ma/o/ok24
export XDG_CACHE_HOME="$HOME/.cache"
export PYOP2_CACHE_DIR="$XDG_CACHE_HOME/pyop2"
export TSFC_KERNEL_CACHE_DIR="$XDG_CACHE_HOME/tsfc"
export TSFC_CACHE_DIR="$XDG_CACHE_HOME/tsfc"
export FIREDRAKE_TSFC_KERNEL_CACHE_DIR="$XDG_CACHE_HOME/tsfc"
export PYOP2_ALWAYS_REBUILD=1
mkdir -p "$PYOP2_CACHE_DIR" "$TSFC_KERNEL_CACHE_DIR"

# --- target NFS (clustor2) SOLO al final ---
DEST_BASE=/home/clustor2/ma/o/ok24/solver_results/heatfiles
mkdir -p "$DEST_BASE"

# --- scratch local para HDF5 (evita NFS durante la ejecuci칩n) ---
SCRATCH="${TMPDIR:-/tmp}/sdc-${USER}-${PBS_JOBID}"
mkdir -p "$SCRATCH"
echo "[SCRATCH] $SCRATCH"

# HDF5 en NFS a veces se bloquea por file locking
export HDF5_USE_FILE_LOCKING=FALSE

# El solver escribir치 en SCRATCH, luego copiamos a clustor2
export SDC_OUTPUT_DIR="$SCRATCH"

# --- directorio de trabajo principal ---
cd /home/ma/o/ok24
echo "[CWD] $(pwd)"
echo "[ENV] SDC_OUTPUT_DIR=$SDC_OUTPUT_DIR"

# --- prueba r치pida de Python ---
python3 -u - <<'PY'
print("[PY] hello ok")
PY

# --- asegurar firedrake OK ---
python3 -u - <<'PY'
print("[PY] importing firedrake...", flush=True)
import firedrake
print("[PY] firedrake OK", flush=True)
PY

# --- ejecutar solver (tu script NO se toca) ---
echo "[RUN] sdc_heat_equation.py start"
time python3 -u /home/ma/o/ok24/clusterscripts/sdc_heat_equation.py
echo "[RUN] sdc_heat_equation.py end"

# --- copiar SOLO resultados .h5 y .json a clustor2 ---
echo "[COPY] to $DEST_BASE"
# crear misma estructura que gener칩 tu script: la carpeta ya viene dentro de SCRATCH
rsync -av --include="*/" --include="*.h5" --include="*.json" --include='*_log.txt' --exclude="*" "$SCRATCH/"/ "$DEST_BASE/"/

# --- limpieza de scratch ---
rm -rf "$SCRATCH" || true

echo "[END] $(date)"